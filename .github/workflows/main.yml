# =======================================================
#         ditzz Ultimate Workflow (RDP) - v9.5
# =======================================================
# Deskripsi: The Ultimate Build. Menggabungkan optimasi v9.3
#            dengan instalasi OBS Studio yang telah dikonfigurasi
#            untuk performa maksimal. Termasuk perbaikan krusial
#            untuk mengatasi error persetujuan winget msstore.
# Architect: ditzz-devnest
# =======================================================

name: ditzz RDP (Ultimate RDP + OBS Performance)

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-2025
    timeout-minutes: 360

    steps:
      - name: "[0] Cache Installers"
        uses: actions/cache@v3
        with:
          path: C:\cached-installers
          key: ${{ runner.os }}-core-installers-v1

      - name: "[1] Create 'ditzz' User for RDP"
        shell: powershell
        run: |
          $ditzzPass = "P@ssword123!";
          net user "ditzz" $ditzzPass /add /fullname:"ditzz";
          Set-LocalUser -Name "ditzz" -PasswordNeverExpires $true;
          net localgroup "Administrators" "ditzz" /add;
          net localgroup "Remote Desktop Users" "ditzz" /add;
          echo "RDP_USER=ditzz" >> $env:GITHUB_ENV
          echo "RDP_PASS=$ditzzPass" >> $env:GITHUB_ENV
          Write-Host "-> User 'ditzz' created and configured for RDP access."

      - name: "[2] Enable RDP & Apply ALL Performance Optimizations"
        shell: powershell
        run: |
          # Langkah ini tetap sama, sudah optimal.
          Write-Host "-> Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "-> Activating Ultimate Performance Power Plan..."
          powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
          $up = powercfg -list | ? {$_ -like "*Ultimate*"} | % {$_.Split(' ')[3]}
          powercfg -setactive $up
          Write-Host "-> Disabling non-essential & telemetry services..."
          Set-MpPreference -DisableRealtimeMonitoring $true
          try { Set-Service -Name "WinDefend" -StartupType Disabled -ErrorAction Stop } catch {}
          Set-Service -Name "wuauserv" -StartupType Disabled
          Set-Service -Name "DiagTrack" -StartupType Disabled -ErrorAction SilentlyContinue
          Set-Service -Name "dmwappushservice" -StartupType Disabled -ErrorAction SilentlyContinue
          Write-Host "-> Applying aggressive debloat..."
          Get-AppxPackage *Microsoft.WindowsStore* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Get-AppxPackage *Xbox* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Get-AppxPackage *Microsoft.People* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Get-AppxPackage *Microsoft.Wallet* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Get-AppxPackage *Microsoft.ZuneMusic* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Get-AppxPackage *Microsoft.ZuneVideo* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Get-AppxPackage *Microsoft.YourPhone* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Get-AppxPackage *Microsoft.WindowsFeedbackHub* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Get-AppxPackage *Microsoft.GetHelp* | Remove-AppxPackage -ErrorAction SilentlyContinue
          Write-Host "-> Disabling mouse acceleration for better input response..."
          Set-ItemProperty -Path "HKCU:\Control Panel\Mouse" -Name "MouseSpeed" -Value "0"
          Set-ItemProperty -Path "HKCU:\Control Panel\Mouse" -Name "MouseThreshold1" -Value "0"
          Set-ItemProperty -Path "HKCU:\Control Panel\Mouse" -Name "MouseThreshold2" -Value "0"
          Write-Host "-> All performance optimizations applied."

      - name: "[3] Install Steam & Tailscale"
        shell: powershell
        run: |
          # Langkah ini tetap sama
          New-Item -Path "C:\cached-installers" -ItemType Directory -ErrorAction SilentlyContinue
          $steamInstaller = "C:\cached-installers\steam-installer.exe"
          if (-not (Test-Path $steamInstaller)) {
              Write-Host "-> Downloading Steam..."
              Invoke-WebRequest -Uri "https://cdn.akamai.steamstatic.com/client/installer/SteamSetup.exe" -OutFile $steamInstaller
          }
          Write-Host "-> Installing Steam..."
          Start-Process -FilePath $steamInstaller -ArgumentList "/S" -Wait
          $tailscaleInstaller = "C:\cached-installers\tailscale-installer.exe"
          if (-not (Test-Path $tailscaleInstaller)) {
              Write-Host "-> Downloading Tailscale..."
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile $tailscaleInstaller
          }
          Write-Host "-> Installing Tailscale..."
          Start-Process -FilePath $tailscaleInstaller -ArgumentList "/S" -Wait
          Write-Host "-> Core software installation complete."

      - name: "[4] Install & Configure OBS Studio for Ultimate Performance"
        shell: powershell
        run: |
          # --- PERBAIKAN KRUSIAL DARI V4.7 ---
          # Menghapus source 'msstore' yang menyebabkan error persetujuan sebelum instalasi.
          Write-Host "-> Removing problematic 'msstore' source to prevent agreement errors..."
          winget source remove msstore
          winget source update
          
          Write-Host "-> Installing OBS Studio..."
          winget install --id=OBSProject.OBSStudio -e --accept-package-agreements --disable-interactivity
          
          Write-Host "-> Applying 'Ultimate Performance' recording profile for OBS..."
          $profileName = "UltimatePerformance"
          $profileDir = "$env:APPDATA\obs-studio\basic\profiles\$profileName"
          New-Item -ItemType Directory -Force -Path $profileDir
          
          $obsConfig = @"
          [General]
          Name=$profileName
          [Video]
          BaseCX=1280
          BaseCY=720
          OutputCX=1280
          OutputCY=720
          FPSCommon=30
          [Output]
          Mode=Advanced
          [AdvOut]
          RecType=Standard
          RecFormat=mp4
          RecEncoder=x264
          RecTracks=1
          x264Settings=crf=23 preset=ultrafast
          "@
          Set-Content -Path "$profileDir\basic.ini" -Value $obsConfig
          Write-Host "-> OBS Studio configured. Profile '$profileName' is ready."
      
      - name: "[5] Connect Tailscale"
        # Langkah ini tetap sama
        shell: powershell
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ditzz-rdp-pc-$env:GITHUB_RUN_ID
          $tsIP = $null
          for ($i=1; $i -le 15; $i++){ $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4; if($tsIP){break}; Start-Sleep 4 }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "-> Tailscale connected successfully with IP: $tsIP"

      - name: "[6] Create Workflow Summary and Maintain Connection"
        # Langkah ini tetap sama
        shell: powershell
        run: |
          $summary = @"
          # ✅ RDP is Ready (Ultimate RDP + OBS Performance)
          
          Mesin ini telah dioptimalkan secara maksimal dan dilengkapi OBS Studio.
          
          ---
          
          ### 🖥️ Access Details
          
          | Property      | Value                               |
          |---------------|-------------------------------------|
          | **IP Address**  | `${{ env.TAILSCALE_IP }}`              |
          | **Username**    | `${{ env.RDP_USER }}`                |
          | **Password**    | `${{ env.RDP_PASS }}`                |
          
          ---
          
          ### 🔴 OBS Studio Siap Pakai!
          
          - **Profil Aktif:** `UltimatePerformance`
          - **Resolusi Rekaman:** 720p @ 30 FPS
          - **Performa:** Sangat ringan, dirancang untuk tidak menyebabkan lag.
          - **Output:** File **MP4** akan disimpan di folder `Videos` Anda.
          
          **Cara Menggunakan:** Buka OBS, tambahkan `Display Capture` di Sources, lalu klik `Start Recording`.
          "@
          echo $summary >> $env:GITHUB_STEP_SUMMARY
          
          Write-Host "`nAll steps complete. RDP is active."
          while ($true) { $ts = Get-Date -f "HH:mm:ss"; Write-Host "[$ts] Connection active..."; Start-Sleep 300 }
